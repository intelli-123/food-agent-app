<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Smart Food Intake</title>
    <link rel="icon" type="image/x-icon" href="tab-icon.ico">
    <style>
        :root { --primary: #4F46E5; --bg: #F3F4F6; --gray: #E5E7EB; --text: #1F2937; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); padding: 40px 20px; color: var(--text); }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 2.5rem; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }

        /* Grid Layout */
        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px; }
        .full-width { grid-column: span 2; }

        label { display: block; font-weight: 600; margin-bottom: 8px; color: #374151; font-size: 0.95rem; }
        input, textarea { width: 100%; padding: 12px; border: 1px solid var(--gray); border-radius: 8px; font-size: 1rem; transition: border 0.2s; box-sizing: border-box; }
        input:focus, textarea:focus { border-color: var(--primary); outline: none; }

        /* THE DECK */
        .deck-container { margin-top: 20px; border: 2px dashed #CBD5E1; padding: 20px; border-radius: 12px; background: #F9FAFB; transition: background 0.2s; }
        .deck-container:hover { background: #F3F4F6; border-color: #9CA3AF; }

        .deck-header { display: flex; justify-content: space-between; margin-bottom: 15px; font-weight: 600; color: #6B7280; font-size: 0.9rem; }

        .image-slots { display: flex; gap: 15px; flex-wrap: wrap; }
        .slot { width: 90px; height: 90px; background: white; border-radius: 8px; border: 1px solid var(--gray); position: relative; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .slot img { width: 100%; height: 100%; object-fit: cover; }
        .slot.empty { display: flex; align-items: center; justify-content: center; background: #fff; border-style: dashed; }
        .slot.empty::after { content: "+"; font-size: 1.5rem; color: #D1D5DB; }

        .remove-btn { position: absolute; top: 4px; right: 4px; background: rgba(0,0,0,0.6); color: white; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center; transition: background 0.2s; }
        .remove-btn:hover { background: #DC2626; }

        /* Actions */
        .action-area { margin-top: 25px; display: flex; flex-direction: column; gap: 10px; }
        .btn-row { display: flex; gap: 15px; }
        .btn { padding: 14px 24px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; font-size: 1rem; flex: 1; transition: all 0.2s; }

        .btn-upload { background: #374151; color: white; }
        .btn-upload:hover { background: #1F2937; }

        .btn-submit { background: var(--primary); color: white; opacity: 0.5; pointer-events: none; }
        .btn-submit.active { opacity: 1; pointer-events: auto; }
        .btn-submit:active { transform: scale(0.98); }

        .validation-msg { font-size: 0.85rem; text-align: center; color: #DC2626; min-height: 20px; font-weight: 500; }
        .validation-msg.valid { color: #16A34A; }

        /* SUBMITTED FEED (CARDS) */
        #feedContainer { max-width: 800px; margin: 40px auto 0; display: grid; gap: 20px; }

        .food-card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.05); display: flex; flex-direction: column; animation: slideUp 0.4s ease; border: 1px solid #E5E7EB; }

        .card-header { padding: 15px 20px; background: #fff; border-bottom: 1px solid #F3F4F6; display: flex; justify-content: space-between; align-items: center; }
        .card-title { font-weight: 700; font-size: 1.1rem; color: #111; }
        .confidence-badge { background: #DCFCE7; color: #166534; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 700; }

        /* Slider */
        .card-media { position: relative; width: 100%; height: 300px; background: #000; }
        .card-media img { width: 100%; height: 100%; object-fit: cover; }

        .slider-btn { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.2); color: white; border: none; padding: 10px; cursor: pointer; font-size: 1.2rem; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px); transition: background 0.2s; }
        .slider-btn:hover { background: rgba(255,255,255,0.4); }
        .prev-btn { left: 15px; }
        .next-btn { right: 15px; }
        .slide-counter { position: absolute; bottom: 10px; right: 15px; background: rgba(0,0,0,0.6); color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; }

        .card-body { padding: 20px; }
        .card-desc { color: #4B5563; line-height: 1.6; font-size: 0.95rem; margin-bottom: 15px; }
        .card-footer { padding-top: 15px; border-top: 1px solid #F3F4F6; display: flex; gap: 10px; font-size: 0.85rem; color: #6B7280; }

        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Toast */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 100; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: white; padding: 12px 16px; border-left: 4px solid; border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: 280px; font-size: 0.9rem; animation: slideIn 0.3s; }
        .toast.error { border-color: #EF4444; }
        .toast.success { border-color: #10B981; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
    </style>
</head>
<body>

<div class="container">
    <h2 style="margin-top:0; color:#111;">üçî Content Intake System</h2>

    <div class="input-grid">
        <div class="full-width">
            <label>Item Name *</label>
            <input type="text" id="itemName" placeholder="e.g. Chicken Biryani" oninput="checkForm()">
        </div>
        <div class="full-width">
            <label>Description *</label>
            <textarea id="itemDesc" rows="3" placeholder="Describe the ingredients, taste, and portion..." oninput="checkForm()"></textarea>
        </div>
    </div>

    <div class="deck-container">
        <div class="deck-header">
            <span>Image Validation Deck (Min 2, Max 5)</span>
            <span id="countDisplay">0 / 5</span>
        </div>
        <div class="image-slots" id="imageDeck">
            </div>
    </div>

    <div class="action-area">
        <div class="validation-msg" id="validationMsg">Start by adding an Item Name and Images.</div>
        <div class="btn-row">
            <button class="btn btn-upload" onclick="triggerUpload()">+ Add Images</button>
            <button class="btn btn-submit" id="finalBtn" onclick="submitFinal()">Submit Item</button>
        </div>
    </div>

    <input type="file" id="fileInput" multiple accept="image/*" style="display:none">
</div>

<div id="feedContainer"></div>

<div class="toast-container" id="toastArea"></div>

<script>
    // State
    const MAX_IMAGES = 5;
    const MIN_IMAGES = 2; // Mandatory Requirement
    let validImages = []; // Stores validated File objects

    // DOM Elements
    const itemNameInput = document.getElementById('itemName');
    const itemDescInput = document.getElementById('itemDesc');
    const fileInput = document.getElementById('fileInput');
    const deckDiv = document.getElementById('imageDeck');
    const countDisplay = document.getElementById('countDisplay');
    const finalBtn = document.getElementById('finalBtn');
    const valMsg = document.getElementById('validationMsg');
    const feedContainer = document.getElementById('feedContainer');

    // 1. Render Deck
    function renderDeck() {
        deckDiv.innerHTML = '';
        validImages.forEach((file, index) => {
            const slot = document.createElement('div');
            slot.className = 'slot';

            const img = document.createElement('img');
            img.src = URL.createObjectURL(file);

            const btn = document.createElement('div');
            btn.className = 'remove-btn';
            btn.innerHTML = '√ó';
            btn.onclick = () => removeImage(index);

            slot.appendChild(img);
            slot.appendChild(btn);
            deckDiv.appendChild(slot);
        });

        // Fill empty slots
        for (let i = validImages.length; i < MAX_IMAGES; i++) {
            const slot = document.createElement('div');
            slot.className = 'slot empty';
            deckDiv.appendChild(slot);
        }

        countDisplay.innerText = `${validImages.length} / ${MAX_IMAGES}`;
        checkForm(); // Re-validate button state
    }

    // 2. Form Validation Logic (The Gatekeeper)
    function checkForm() {
        const hasName = itemNameInput.value.trim().length > 0;
        const hasDesc = itemDescInput.value.trim().length > 0;
        const imgCount = validImages.length;

        let msg = "";
        let isValid = false;

        if (!hasName) {
            msg = "Item Name is required.";
        } else if (!hasDesc) {
            msg = "Description is required.";
        } else if (imgCount < MIN_IMAGES) {
            msg = `Need ${MIN_IMAGES - imgCount} more valid image(s) to submit.`;
        } else {
            msg = "Ready to Submit!";
            isValid = true;
        }

        valMsg.innerText = msg;
        if (isValid) {
            valMsg.className = "validation-msg valid";
            finalBtn.classList.add('active');
        } else {
            valMsg.className = "validation-msg";
            finalBtn.classList.remove('active');
        }
    }

    renderDeck();

    // 3. Upload & Validate
    function triggerUpload() {
        const name = itemNameInput.value.trim();
        const desc = itemDescInput.value.trim();

        if (!name) { showToast("Enter Item Name first!", "error"); return; }
        // We allow upload without description, but submit requires it.

        if (validImages.length >= MAX_IMAGES) {
            showToast("Deck is full.", "error");
            return;
        }
        fileInput.click();
    }

    fileInput.addEventListener('change', async (e) => {
        const files = Array.from(e.target.files);
        if (files.length === 0) return;

        showToast(`Validating ${files.length} images...`, "success");

        const formData = new FormData();
        formData.append('itemName', itemNameInput.value);
        formData.append('itemDescription', itemDescInput.value);

        const remaining = MAX_IMAGES - validImages.length;
        files.slice(0, remaining).forEach(f => formData.append('foodImages', f));

        try {
            const res = await fetch('/api/validate', { method: 'POST', body: formData });
            const data = await res.json();

            data.results.forEach((result, index) => {
                if (result.isValid) {
                    validImages.push(files[index]);
                    showToast("‚úÖ Image Approved", "success");
                } else {
                    showToast(`‚ùå Rejected: ${result.reason}`, "error");
                }
            });

            renderDeck();
            fileInput.value = "";

        } catch (err) {
            showToast("Server Validation Failed", "error");
        }
    });

    function removeImage(index) {
        validImages.splice(index, 1);
        renderDeck();
    }

    function showToast(msg, type) {
        const area = document.getElementById('toastArea');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerText = msg;
        area.appendChild(toast);
        setTimeout(() => toast.remove(), 4000);
    }

    // 4. Final Submission & Feed Rendering
    async function submitFinal() {
        finalBtn.innerText = "Analyzing & Submitting...";

        const formData = new FormData();
        formData.append('itemName', itemNameInput.value);
        formData.append('itemDescription', itemDescInput.value);
        validImages.forEach(f => formData.append('foodImages', f));

        try {
            const res = await fetch('/api/identify', { method: 'POST', body: formData });
            const data = await res.json();

            if (data.success) {
                // Add Card to Feed
                addCardToFeed(
                    itemNameInput.value,
                    itemDescInput.value,
                    validImages,
                    data.analysis
                );

                // Reset Form
                itemNameInput.value = "";
                itemDescInput.value = "";
                validImages = [];
                renderDeck();
                showToast("Item Submitted Successfully!", "success");
            }

        } catch(e) {
            showToast("Submission Failed", "error");
        } finally {
            finalBtn.innerText = "Submit Item";
        }
    }

    // 5. Card Generator (UI Logic)
    function addCardToFeed(name, desc, imageFiles, analysisData) {
        const cardId = Date.now(); // Unique ID for slider
        const imageUrls = imageFiles.map(file => URL.createObjectURL(file));
        const confidence = analysisData.data ? analysisData.data.confidence : 0;
        const isMatch = analysisData.data ? analysisData.data.isMatch : false;

        const cardHTML = `
            <div class="food-card" id="card-${cardId}">
                <div class="card-header">
                    <div class="card-title">${name}</div>
                    <div class="confidence-badge" style="background:${isMatch ? '#DCFCE7' : '#FEE2E2'}; color:${isMatch ? '#166534' : '#991B1B'}">
                        ${isMatch ? 'VERIFIED' : 'FLAGGED'} (${confidence}%)
                    </div>
                </div>

                <div class="card-media">
                    <img src="${imageUrls[0]}" id="img-${cardId}" data-idx="0">
                    ${imageUrls.length > 1 ? `
                        <button class="slider-btn prev-btn" onclick="slide('${cardId}', -1)">&#8249;</button>
                        <button class="slider-btn next-btn" onclick="slide('${cardId}', 1)">&#8250;</button>
                        <div class="slide-counter" id="cnt-${cardId}">1 / ${imageUrls.length}</div>
                    ` : ''}
                </div>

                <div class="card-body">
                    <div class="card-desc">${desc}</div>
                    <div class="card-footer">
                        <span><strong>Analysis:</strong> ${analysisData.data ? analysisData.data.analysis : "No data"}</span>
                    </div>
                </div>
            </div>
        `;

        // Store images in a global object to access them for sliding
        window[`images_${cardId}`] = imageUrls;

        feedContainer.insertAdjacentHTML('afterbegin', cardHTML);
    }

    // Slider Logic
    window.slide = function(cardId, direction) {
        const imgEl = document.getElementById(`img-${cardId}`);
        const cntEl = document.getElementById(`cnt-${cardId}`);
        const images = window[`images_${cardId}`];

        let currentIdx = parseInt(imgEl.dataset.idx);
        let newIdx = currentIdx + direction;

        // Loop functionality
        if (newIdx < 0) newIdx = images.length - 1;
        if (newIdx >= images.length) newIdx = 0;

        imgEl.src = images[newIdx];
        imgEl.dataset.idx = newIdx;
        cntEl.innerText = `${newIdx + 1} / ${images.length}`;
    };
</script>

</body>
</html>